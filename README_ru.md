# Захват трафика из подов Kubernetes

Скрипт для простого и эффективного захвата сетевого трафика из подов Kubernetes.

## Обзор

Иногда необходимо захватить сетевой трафик из подов, где не установлены tcpdump или tshark. Решение заключается в добавлении "sidecar" контейнера в тот же под. Поскольку все контейнеры в поде разделяют одно и то же **сетевое** пространство имен, sidecar может захватывать трафик так, как если бы tcpdump работал как соседний процесс.

> **Примечание**: Хотя контейнеры разделяют сетевое пространство имен, они не разделяют дисковое пространство или пространство процессов по умолчанию, поэтому вы не можете получить доступ к файлам из других контейнеров в том же поде без дополнительной настройки.

## Предыстория

Этот скрипт был вдохновлен [данной статьей](https://medium.com/@rakhitharr/debug-network-traffic-in-kubernetes-using-a-sidecar-fd1671d8a35b). Изначально я выполнял эти действия вручную, но когда мне потребовалось захватить трафик с нескольких подов одновременно, я автоматизировал процесс с помощью этого скрипта.

## Как это работает

Скрипт выполняет следующие действия:

1. Подключается к указанным подам
2. Присоединяет sidecar контейнер (nicolaka/netshoot)
3. Запускает tcpdump в sidecar контейнере
4. Копирует захваченные данные на локальную машину
5. Удаляет sidecar контейнер
6. Создает лог-файл со всеми выполненными действиями

## Использование

### Предварительные требования

- Вы должны быть аутентифицированы с kubectl для доступа к вашей среде Kubernetes
- Скрипт требует соответствующих разрешений для создания и управления подами в целевом пространстве имен

### Синтаксис команды

```bash
./capture_traffic_batch.sh -n <namespace> -p <pod_prefix> -d <duration_minutes>
```

### Параметры

| Параметр | Описание | Обязательный |
|----------|----------|--------------|
| `-n` | Пространство имен Kubernetes | Да |
| `-p` | Префикс имени пода для поиска | Да |
| `-d` | Длительность tcpdump в минутах | Да |

### Пример

```bash
./capture_traffic_batch.sh -n glip-ha-lab -p gas -d 10
```

Эта команда захватит трафик со всех подов в пространстве имен `glip-ha-lab`, которые начинаются с `gas`, в течение 10 минут.

### Справочная информация

Запуск скрипта без параметров показывает информацию об использовании:

```bash
user@host:~$ ./capture_traffic_batch.sh
Usage: ./capture_traffic_batch.sh -n <namespace> -p <pod_prefix> -d <duration_minutes>

  -n     Kubernetes namespace (required)
  -p     Pod name prefix (required)
  -d     Tcpdump duration in minutes (required)

Example:
  ./capture_traffic_batch.sh -n glip-ha-lab -p gas -d 10

Don't forget: you need to be authenticated in advance to run kubectl against your environment
```

## Результат работы

Скрипт генерирует следующие файлы и директории:

- **Директория**: `./pcaps_<ИмяПода>-<ГГГГ-ММ-ДДTЧЧ-ММ-ССZ>/` - Содержит все захваченные данные
- **Лог-файл**: `./pcaps_<ИмяПода>-<ГГГГ-ММ-ДДTЧЧ-ММ-ССZ>/pcap-dump.log` - Записывает все выполненные действия
- **Файл захвата**: `./pcaps_<ИмяПода>-<ГГГГ-ММ-ДДTЧЧ-ММ-ССZ>/<ИмяПода>-<хеш-пода>.pcap` - Фактический сетевой захват

### Пример структуры результата

```
./pcaps_MyPodName-2023-07-11T10-17-17Z/
├── pcap-dump.log
└── MyPodName-79cbffb479-qgwbd.pcap
```

## Возможности

- **Пакетная обработка**: Захват трафика с нескольких подов одновременно
- **Автоматическое управление sidecar**: Автоматически присоединяет и удаляет sidecar контейнеры
- **Организованный вывод**: Создает директории с временными метками для каждой сессии захвата
- **Подробное логирование**: Записывает все действия для устранения неполадок и аудита
- **Чистая очистка**: Удаляет временные sidecar контейнеры после завершения захвата

## Технические детали

- **Образ Sidecar**: Использует контейнер `nicolaka/netshoot` для возможностей отладки сети
- **Разделение сети**: Использует разделение сетевого пространства имен подов Kubernetes
- **Формат файла**: Захваты сохраняются в стандартном формате pcap для анализа с помощью Wireshark или других инструментов

## Устранение неполадок

- Убедитесь, что у вас есть необходимые RBAC разрешения для создания подов в целевом пространстве имен
- Проверьте, что префикс пода соответствует существующим подам в указанном пространстве имен
- Убедитесь, что образ `nicolaka/netshoot` доступен из вашего кластера
- Просмотрите сгенерированные лог-файлы для получения подробной информации об ошибках

## TODO

- Добавить опции для фильтрации захватываемого трафика по портам или IP-адресам

## Лицензия

Этот проект предоставляется как есть для образовательных и операционных целей.
